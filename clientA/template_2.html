<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice #{{ order.number }}</title>
    <style>
        :root {
            --primary: #1e293b; /* Slate 900 */
            --accent: #2563eb;  /* Royal Blue */
            --bg-light: #f8fafc; /* Slate 50 */
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        @media print {
            @page { margin: 0; }
            body { 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                padding: 20px;
            }
            .no-print { display: none; }
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-main);
            background: #fff;
            font-size: 12px;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        .invoice-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: white;
        }

        /* Header Section */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .brand-section img {
            max-height: 60px;
            margin-bottom: 10px;
        }

        .brand-section h1 {
            margin: 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
            margin: 0;
            line-height: 1;
        }

        .invoice-number {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .status-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 10px;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-col h3 {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .info-col p {
            margin: 0;
            font-weight: 500;
        }

        .info-col .highlight {
            color: var(--accent);
            font-weight: 700;
        }

        /* Items Table */
        .table-container {
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--bg-light);
            color: var(--primary);
            font-size: 11px;
            text-transform: uppercase;
            text-align: left;
            padding: 12px 8px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .item-name {
            font-weight: 600;
            color: var(--primary);
        }

        .item-modifiers {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.3;
        }
        
        .item-modifiers ul {
            padding-left: 0;
            list-style: none;
            margin: 0;
        }

        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* Summary Section */
        .summary-section {
            display: flex;
            justify-content: space-between;
        }

        .notes-section {
            width: 50%;
            font-size: 11px;
            color: var(--text-muted);
            padding-right: 20px;
        }
        
        .aggregator-box {
            background: var(--bg-light);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .totals-section {
            width: 40%;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 11px;
        }

        .total-row.final {
            border-top: 2px solid var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
        }

        .footer {
            margin-top: 60px;
            text-align: center;
            font-size: 10px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }
    </style>
</head>
<body>

    <div class="invoice-wrapper">
        <header>
            <div class="brand-section">
                {% if order.store.logo %}
                    <img src="{{ order.store.logo.url }}" alt="Store Logo">
                {% else %}
                    <h1>{{ order.store.name }}</h1>
                {% endif %}
                <div>{{ order.store.address|default:"Store Address" }}</div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-title">INVOICE</div>
                <div class="invoice-number">#{{ order.number }}</div>
                <div class="invoice-number">{{ order.created|date:"M j, Y - H:i" }}</div>
                <div class="status-badge">{{ order.get_status_display }}</div>
            </div>
        </header>

        <div class="info-grid">
            <div class="info-col">
                <h3>Bill To</h3>
                <p class="highlight">{{ order.user.name|default:"Guest Customer" }}</p>
                {% if order.user.mobile_number %}
                    <p>{{ order.user.mobile_number }}</p>
                {% endif %}
                {% if order.user.email %}
                    <p>{{ order.user.email }}</p>
                {% endif %}
            </div>

            <div class="info-col">
                <h3>Order Type</h3>
                <p>{{ order.get_type_display }}</p>
                {% if order.type == OrderType.DINE_IN %}
                    <p>Table: <span class="highlight">{{ order.table_number|default:"-" }}</span></p>
                {% else %}
                    <p>Takeaway #: <span class="highlight">{{ order.table_number|default:"-" }}</span></p>
                {% endif %}
                {% if order.delivery_type %}
                    <p>Via: {{ order.get_delivery_type_display }}</p>
                {% endif %}
            </div>

            <div class="info-col">
                <h3>Details</h3>
                <p>Server: {{ order.employee.user.name|default:"-" }}</p>
                <p>Pay Method: {{ order.get_payment_method_display }}</p>
                <p>Pay Status: {{ order.get_payment_status_display }}</p>
                {% if order.card_number %}
                    <p>Card: **** {{ order.card_number|slice:"-4:" }}</p>
                {% endif %}
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 45%">Item Description</th>
                        <th class="text-center">Qty</th>
                        <th class="text-right">Unit Price</th>
                        <th class="text-right">Disc.</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>
                            <div class="item-name">{{ item.inventory.variant.name }}</div>
                            {% if item.notes %}
                                <div class="item-modifiers" style="font-style: italic;">Note: {{ item.notes }}</div>
                            {% endif %}
                            
                            {% if item.prefetched_modifiers %}
                                <div class="item-modifiers">
                                    <ul>
                                        {% for item_modifier in item.prefetched_modifiers %}
                                            <li>
                                                + {{ item_modifier.value }}x {{ item_modifier.get_modifier }}
                                                {% if item_modifier.prefetched_modifier_children %}
                                                    {% for modifier in item_modifier.prefetched_modifier_children %}
                                                        ( {{ modifier.value }}x {{ modifier.get_modifier }} )
                                                    {% endfor %}
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-right">{{ item.price_per_unit }}</td>
                        <td class="text-right">{{ item.item_discount_value|default:"-" }}</td>
                        <td class="text-right">{{ item.post_discount_subtotal }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="summary-section">
            <div class="notes-section">
                {% if order.notes %}
                    <h3>Notes:</h3>
                    <p>{{ order.notes }}</p>
                {% endif %}

                {% if order.aggregator_metadata %}
                    <div class="aggregator-box">
                        <strong>Delivery Details:</strong><br>
                        App: {{ order.aggregator_metadata.get_type_display }}<br>
                        Driver: {{ order.aggregator_metadata.driver_name|default:"-" }}<br>
                        PIN: <strong>{{ order.aggregator_metadata.pickup_pin|default:"-" }}</strong><br>
                        Ext ID: {{ order.aggregator_metadata.short_order_number }}
                    </div>
                {% endif %}
            </div>

            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal</span>
                    <span>{{ order.subtotal }}</span>
                </div>

                {% if order.discount_value %}
                <div class="total-row" style="color: #ef4444;">
                    <span>Discount</span>
                    <span>- {{ order.discount_value }}</span>
                </div>
                {% endif %}

                {% if order.service_charge %}
                <div class="total-row">
                    <span>Service Charge</span>
                    <span>{{ order.service_charge }}</span>
                </div>
                {% endif %}

                {% if order.takeaway_fee %}
                <div class="total-row">
                    <span>Takeaway Fee</span>
                    <span>{{ order.takeaway_fee }}</span>
                </div>
                {% endif %}

                {% if order.delivery_fee %}
                <div class="total-row">
                    <span>Delivery Fee</span>
                    <span>{{ order.delivery_fee }}</span>
                </div>
                {% endif %}

                {% if order.tax %}
                <div class="total-row">
                    <span>Tax (PB1/PPN)</span>
                    <span>{{ order.tax }}</span>
                </div>
                {% endif %}

                {% if order.rounding %}
                <div class="total-row">
                    <span>Rounding</span>
                    <span>{{ order.rounding }}</span>
                </div>
                {% endif %}

                <div class="total-row final">
                    <span>TOTAL</span>
                    <span>{{ order.grand_total }}</span>
                </div>

                <div class="total-row" style="margin-top: 15px; color: var(--text-muted); font-size: 10px;">
                    <span>Tendered ({{ order.get_payment_method_display }})</span>
                    {% if order.payment_method == PaymentMethods.CASH %}
                        <span>{{ order.cash_tender_amount|default:"-" }}</span>
                    {% else %}
                        <span>{{ order.grand_total }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Thank you for your business.</p>
            <p>{{ order.store.name }} - NPWP: {{ order.store.npwp|default:"-" }}</p>
        </div>
    </div>

    <script>
        document.title = "invoice_{{ order.number }}";
        window.print();
    </script>
</body>
</html>